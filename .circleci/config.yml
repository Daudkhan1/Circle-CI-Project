version: 2.1

jobs:
  build-and-push-docker-image:
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: Log in to Docker Hub
          command: |
            echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

      - run:
          name: Build and push Docker image
          command: |
            export IMAGE_NAME=daudidrees/githubaction-flask:${CIRCLE_SHA1}
            docker build -t $IMAGE_NAME .
            docker push $IMAGE_NAME

  update-and-push-deployment-manifest:
    docker:
      - image: alpine/git
    steps:
      - checkout

      - run:
          name: Skip workflow if triggered by Actions
          command: |
            if [[ "$(git log -1 --pretty=%an)" == "github-actions[bot]" ]]; then
              echo "Skipping workflow as it was triggered by a bot commit."
              exit 0
            fi

      - run:
          name: Update deployment manifest
          command: |
            git clone https://github.com/Daudkhan1/cd-cd-gitops.git
            cd cd-cd-gitops
            sed -i "s|image: .*|image: daudidrees/githubaction-flask:${CIRCLE_SHA1}|" deployment.yml
            git config --global user.email "daudidrees1024@gmail.com"
            git config --global user.name "Daudkhan1"
            git add deployment.yml
            git commit -m "Update deployment.yml with build ${CIRCLE_BUILD_NUM}"
            git push https://${GH_PAT}@github.com/Daudkhan1/cd-cd-gitops.git main

workflows:
  version: 2
  build-deploy:
    jobs:
      - build-and-push-docker-image
      - update-and-push-deployment-manifest:
          requires:
            - build-and-push-docker-image
